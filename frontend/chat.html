<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>ì±„íŒ…</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: #f4f7f6; }
        /* --- ğŸ‘‡ í—¤ë” ìŠ¤íƒ€ì¼ ì¶”ê°€ ğŸ‘‡ --- */
        .header { background-color: white; padding: 15px 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header a { color: #333; text-decoration: none; font-weight: bold; }
        .header h2 { margin: 0; font-size: 20px; }
        /* --- --- */
        .chat-container { max-width: 600px; margin: 30px auto; background-color: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: calc(80vh - 60px); }
        .chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 80%; }
        .message.sent { align-self: flex-end; align-items: flex-end; }
        .message.received { align-self: flex-start; align-items: flex-start; }
        .message-content { display: inline-block; padding: 10px 15px; border-radius: 20px; text-align: left; }
        .message.sent .message-content { background-color: #007bff; color: white; }
        .message.received .message-content { background-color: #e9e9eb; }
        .sender-name { font-size: 12px; color: #666; margin: 0 8px 4px; }
        .chat-input { display: flex; padding: 20px; border-top: 1px solid #ddd; }
        #chat-message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
        #chat-message-submit { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; margin-left: 10px; cursor: pointer; transition: background-color 0.2s; }
        #chat-message-submit:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <header class="header">
        <a href="/chats/">â€¹ ë’¤ë¡œê°€ê¸°</a>
        <h2>ì±„íŒ…</h2>
        <div></div>
    </header>
    <div class="chat-container">
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
            <input id="chat-message-input" type="text" autocomplete="off" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
            <button id="chat-message-submit" disabled>â¤</button>
        </div>
    </div>

    {{ user2_id|json_script:"user2_id" }}

    <script>
        // JavaScript ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
        window.addEventListener('load', () => {
            const user2_id = JSON.parse(document.getElementById('user2_id').textContent);
            const chatLog = document.getElementById('chat-log');
            const messageInput = document.getElementById('chat-message-input');
            const messageSubmit = document.getElementById('chat-message-submit');
            const token = localStorage.getItem('accessToken');
            let my_username = '';

            async function initializeChat() {
                if (!token) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/';
                    return;
                }
                try {
                    const response = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch user info');
                    const myInfo = await response.json();
                    my_username = myInfo.username;
                    setupWebSocket();
                } catch (error) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/';
                }
            }

            function setupWebSocket() {
                const chatSocket = new WebSocket(
                    'ws://' + window.location.host + '/ws/chat/' + user2_id + '/?token=' + token
                );

                chatSocket.onopen = function(e) {
                    console.log("Chat socket successfully opened.");
                    messageSubmit.disabled = false;
                    messageInput.focus();
                };

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    if (data.sender_username === my_username) {
                        messageElement.classList.add('sent');
                    } else {
                        messageElement.classList.add('received');
                    }
                    messageElement.innerHTML = `
                        <div class="sender-name">${data.sender_username}</div>
                        <div class="message-content">${data.message}</div>
                    `;
                    chatLog.appendChild(messageElement);
                    chatLog.scrollTop = chatLog.scrollHeight;
                };

                chatSocket.onclose = function(e) {
                    console.error('Chat socket closed unexpectedly');
                    messageSubmit.disabled = true;
                };

                messageInput.onkeyup = function(e) {
                    if (e.key === 'Enter') { messageSubmit.click(); }
                };

                messageSubmit.onclick = function(e) {
                    const message = messageInput.value;
                    if (message.trim() === '') return;
                    if (chatSocket.readyState === WebSocket.OPEN) {
                        chatSocket.send(JSON.stringify({ 'message': message }));
                        messageInput.value = '';
                    }
                };
            }
            initializeChat();
        });
    </script>
</body>
</html>