<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; margin: 0; background-color: #f4f7f6; }
        .chat-container { max-width: 600px; margin: 50px auto; background-color: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 80vh; }
        .chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 80%; }
        .message.sent { align-self: flex-end; align-items: flex-end; }
        .message.received { align-self: flex-start; align-items: flex-start; }
        .message-content { display: inline-block; padding: 10px 15px; border-radius: 20px; text-align: left; }
        .message.sent .message-content { background-color: #007bff; color: white; }
        .message.received .message-content { background-color: #e9e9eb; }
        .sender-name { font-size: 12px; color: #666; margin: 0 8px 4px; }
        .chat-input { display: flex; padding: 20px; border-top: 1px solid #ddd; }
        #chat-message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; }
        #chat-message-submit { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
            <input id="chat-message-input" type="text" autocomplete="off">
            <button id="chat-message-submit">â¤</button>
        </div>
    </div>

    {{ user2_id|json_script:"user2_id" }}

    <script>
        const user2_id = JSON.parse(document.getElementById('user2_id').textContent);
        const chatLog = document.getElementById('chat-log');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');
        const token = localStorage.getItem('accessToken');
        
        let my_username = ''; // ë‚˜ì¤‘ì— ì±„ì›Œì§ˆ ë‚´ ì•„ì´ë”” ë³€ìˆ˜

        // --- ë¡œì§ ì „ì²´ ì¬êµ¬ì„± ---
        async function initializeChat() {
            // 1. í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }

            // 2. /api/users/me APIë¥¼ í˜¸ì¶œí•´ì„œ ë‚´ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
            try {
                const response = await fetch('/api/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch user info');
                
                const myInfo = await response.json();
                my_username = myInfo.username; // ë‚´ ì•„ì´ë””ë¥¼ ë³€ìˆ˜ì— ì €ì¥

                // 3. ë‚´ ì •ë³´ ë¡œë”© ì„±ê³µ í›„, WebSocket ì—°ê²° ì‹œì‘
                setupWebSocket();

            } catch (error) {
                console.error('Failed to initialize chat:', error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/';
            }
        }

        function setupWebSocket() {
            const chatSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/' + user2_id + '/?token=' + token
            );

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const messageElement = document.createElement('div');
                
                messageElement.classList.add('message');
                if (data.sender_username === my_username) { // ì´ì œ my_username ë³€ìˆ˜ëŠ” ì •í™•í•œ ê°’ì„ ê°€ì§
                    messageElement.classList.add('sent');
                } else {
                    messageElement.classList.add('received');
                }
                
                messageElement.innerHTML = `
                    <div class="sender-name">${data.sender_username}</div>
                    <div class="message-content">${data.message}</div>
                `;
                chatLog.appendChild(messageElement);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };

            messageInput.focus();
            messageInput.onkeyup = function(e) {
                if (e.key === 'Enter') { messageSubmit.click(); }
            };

            messageSubmit.onclick = function(e) {
            console.log("--- ğŸ•µï¸ ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ë¨ ---");
            const message = messageInput.value;

            // 1. WebSocketì˜ í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            // (1: OPEN, 3: CLOSED)
            console.log(" - í˜„ì¬ WebSocket ìƒíƒœ:", chatSocket.readyState);

            if (message.trim() === '') {
                console.log(" - ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆì–´ ì „ì†¡í•˜ì§€ ì•ŠìŒ");
                return;
            }

            // 2. ì—°ê²°ì´ ì—´ë ¤ìˆëŠ” ìƒíƒœ(OPEN)ì¼ ë•Œë§Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
            if (chatSocket.readyState === WebSocket.OPEN) { // WebSocket.OPENì€ ìˆ«ì 1ì…ë‹ˆë‹¤.
                console.log(" - ì—°ê²°ì´ ì—´ë ¤ìˆì–´ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:", message);
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInput.value = '';
                console.log(" - ë©”ì‹œì§€ ì „ì†¡ ì‹œë„ ì™„ë£Œ");
            } else {
                console.log(" - WebSocketì´ ì—´ë ¤ìˆì§€ ì•Šì•„ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ì—†ìŒ!");
                alert("ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            }
        };
        }

        // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì±„íŒ… ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        window.addEventListener('load', initializeChat);
    </script>
</body>
</html>